"""
Генератор документов для перепланировки квартир по российским стандартам
"""

from datetime import datetime
from typing import Dict, List, Any
from .models import FloorPlan, AnalysisResult, RenovationPlan


class DocumentGenerator:
    """Генератор документов для процесса согласования перепланировки"""

    def __init__(self):
        self.current_date = datetime.now().strftime("%d.%m.%Y")

    def generate_application(
        self,
        apartment_data: Dict[str, Any],
        owner_data: Dict[str, Any],
        plan: FloorPlan,
        analysis: AnalysisResult
    ) -> str:
        """
        Генерация заявления на перепланировку квартиры
        Форма согласно ПП РФ от 28.04.2005 № 266
        """

        # Адрес квартиры
        address = apartment_data.get("address", "")
        apartment_number = apartment_data.get("apartment_number", "")
        cadastral_number = apartment_data.get("cadastral_number", "")
        total_area = apartment_data.get("total_area", "")

        # Данные собственника
        owner_name = owner_data.get("full_name", "")
        owner_passport = owner_data.get("passport_series", "") + " " + owner_data.get("passport_number", "")
        owner_issued_by = owner_data.get("passport_issued_by", "")
        owner_issued_date = owner_data.get("passport_issued_date", "")
        owner_phone = owner_data.get("phone", "")
        owner_email = owner_data.get("email", "")

        document = f"""
                            ЗАЯВЛЕНИЕ
                о согласовании перепланировки жилого помещения

                                        В Жилищную инспекцию
                                        _______________________________
                                        (наименование района/округа)

                                        от ____________________________
                                            {owner_name}
                                        _______________________________
                                        Адрес регистрации: {address}
                                        Телефон: {owner_phone}
                                        Email: {owner_email}


    Я, {owner_name}, являясь собственником жилого помещения, расположенного по адресу:
{address}, кв. {apartment_number}, общей площадью {total_area} кв.м.,
кадастровый номер: {cadastral_number},

ПРОШУ:

    Разрешить произвести перепланировку указанного жилого помещения согласно
приложенному проекту перепланировки.

ОПИСАНИЕ ПЛАНИРУЕМЫХ РАБОТ:

{self._format_renovation_description(plan)}

ОСНОВАНИЕ:

    1. Свидетельство о праве собственности (или Выписка из ЕГРН)
    2. Технический паспорт БТИ
    3. Проект перепланировки с техническим заключением
    4. Согласие всех собственников (при наличии)

ОБЯЗУЮСЬ:

    1. Производить перепланировку в соответствии с утвержденным проектом
    2. Обеспечить качество работ и соблюдение строительных норм
    3. По окончании работ обеспечить приемку выполненных работ комиссией
    4. Оформить акт о завершенной перепланировке
    5. Внести изменения в технический паспорт БТИ

ПРИЛОЖЕНИЯ:

    1. Копия документа, удостоверяющего личность
    2. Правоустанавливающие документы на жилое помещение
    3. Технический паспорт БТИ (поэтажный план и экспликация)
    4. Проект перепланировки
    5. Техническое заключение о возможности перепланировки
    6. Согласие всех собственников (при долевой собственности)
    7. Согласие членов семьи нанимателя (для муниципального жилья)


Дата: {self.current_date}                          Подпись: _______________ ({owner_name})


---
ОТМЕТКА О ПРИЕМЕ ДОКУМЕНТОВ:

Документы приняты: "___" __________ 20___ г.

Регистрационный номер: _______________

Специалист: ___________________________  Подпись: _______________
        """

        return document

    def generate_technical_conclusion(
        self,
        apartment_data: Dict[str, Any],
        plan: FloorPlan,
        analysis: AnalysisResult
    ) -> str:
        """
        Генерация технического заключения о возможности перепланировки
        """

        address = apartment_data.get("address", "")
        apartment_number = apartment_data.get("apartment_number", "")
        building_type = plan.buildingType
        floor = plan.floor
        total_floors = plan.totalFloors

        document = f"""
                    ТЕХНИЧЕСКОЕ ЗАКЛЮЧЕНИЕ
        о возможности и безопасности перепланировки жилого помещения

№ _________                                                     {self.current_date}


ОБЪЕКТ ОБСЛЕДОВАНИЯ:
    Жилое помещение, расположенное по адресу: {address}, кв. {apartment_number}
    Тип здания: {self._get_building_type_name(building_type)}
    Этаж: {floor} из {total_floors}

ЦЕЛЬ ОБСЛЕДОВАНИЯ:
    Определение возможности производства перепланировки согласно представленному
    проекту без ущерба для несущих конструкций здания и инженерных систем.

НОРМАТИВНЫЕ ДОКУМЕНТЫ:
    - Жилищный кодекс РФ (ст. 25, 26, 29)
    - СНиП 31-01-2003 "Здания жилые многоквартирные"
    - СНиП 2.01.07-85* "Нагрузки и воздействия"
    - СанПиН 2.1.2.2645-10 "Санитарные требования к жилым зданиям"
    - ПП РФ от 28.04.2005 № 266

ВЫПОЛНЕННЫЕ РАБОТЫ:
    1. Визуальное обследование конструкций
    2. Анализ технической документации БТИ
    3. Изучение проектной документации здания
    4. Оценка технического состояния несущих стен
    5. Проверка соответствия планируемых работ нормативным требованиям

РЕЗУЛЬТАТЫ ОБСЛЕДОВАНИЯ:

{self._format_technical_analysis(analysis)}

ПЛАНИРУЕМЫЕ РАБОТЫ:

{self._format_renovation_description(plan)}

ЗАКЛЮЧЕНИЕ:

{self._generate_conclusion(analysis)}

РЕКОМЕНДАЦИИ:

{self._generate_recommendations(analysis)}


Ответственный специалист:

_______________________________
(Должность, ФИО)

Квалификационный аттестат: № _________

Допуск СРО: № _________

Печать организации                              Подпись: _______________

Дата: {self.current_date}
        """

        return document

    def generate_completion_act(
        self,
        apartment_data: Dict[str, Any],
        owner_data: Dict[str, Any],
        completion_date: str
    ) -> str:
        """
        Генерация акта о завершении перепланировки
        """

        address = apartment_data.get("address", "")
        apartment_number = apartment_data.get("apartment_number", "")
        owner_name = owner_data.get("full_name", "")

        document = f"""
                        АКТ О ЗАВЕРШЕННОЙ ПЕРЕПЛАНИРОВКЕ
                            жилого помещения

№ _________                                                     {completion_date}


КОМИССИЯ В СОСТАВЕ:

Представитель жилищной инспекции: _______________________________________

Представитель эксплуатирующей организации: ______________________________

Представитель проектной организации: ____________________________________

Собственник жилого помещения: {owner_name}


Произвела осмотр жилого помещения, расположенного по адресу:
{address}, кв. {apartment_number}

УСТАНОВИЛА:

1. Перепланировка выполнена в соответствии с проектом, согласованным
   распоряжением № _____ от "___" __________ 20___ г.

2. Отклонений от утвержденного проекта: НЕ ВЫЯВЛЕНО

3. Несущие конструкции здания: НЕ ЗАТРОНУТЫ

4. Инженерные системы здания: ФУНКЦИОНИРУЮТ В ШТАТНОМ РЕЖИМЕ

5. Соблюдение санитарных норм: ПОДТВЕРЖДАЕТСЯ

6. Соблюдение строительных норм: ПОДТВЕРЖДАЕТСЯ

7. Качество выполненных работ: СООТВЕТСТВУЕТ ТРЕБОВАНИЯМ


ВЫПОЛНЕННЫЕ РАБОТЫ:

    □ Демонтаж ненесущих перегородок
    □ Установка новых перегородок
    □ Перенос дверных проемов
    □ Перепланировка санузла
    □ Перепланировка кухни
    □ Объединение помещений
    □ Изменение инженерных систем
    □ Иное: ___________________________________________________________


ЗАКЛЮЧЕНИЕ КОМИССИИ:

    Перепланировка жилого помещения выполнена в полном соответствии с
утвержденным проектом. Нарушений строительных и санитарных норм не выявлено.

    Перепланировку считать ЗАВЕРШЕННОЙ.

    Рекомендуется внесение изменений в технический паспорт БТИ и Единый
государственный реестр недвижимости (ЕГРН).


ПОДПИСИ ЧЛЕНОВ КОМИССИИ:

Представитель жилищной инспекции: ______________ / ____________________

Представитель эксплуатирующей организации: ______________ / ____________

Представитель проектной организации: ______________ / __________________

Собственник жилого помещения: ______________ / {owner_name}


Дата: {completion_date}

М.П.
        """

        return document

    def generate_bti_application(
        self,
        apartment_data: Dict[str, Any],
        owner_data: Dict[str, Any]
    ) -> str:
        """
        Генерация заявления в БТИ для получения нового техпаспорта
        """

        address = apartment_data.get("address", "")
        apartment_number = apartment_data.get("apartment_number", "")
        owner_name = owner_data.get("full_name", "")
        owner_phone = owner_data.get("phone", "")

        document = f"""
                            ЗАЯВЛЕНИЕ
                в Бюро технической инвентаризации

                                        Директору БТИ
                                        _______________________________

                                        от ____________________________
                                            {owner_name}
                                        _______________________________
                                        Телефон: {owner_phone}


ПРОШУ:

    Внести изменения в технический паспорт жилого помещения, расположенного
по адресу: {address}, кв. {apartment_number}, в связи с выполненной и
согласованной перепланировкой.

    Выдать новый технический паспорт с актуальным поэтажным планом и экспликацией.


ОСНОВАНИЕ:

    1. Распоряжение о согласовании перепланировки № _____ от "___" ______ 20__ г.
    2. Акт приемочной комиссии о завершенной перепланировке от {self.current_date}


ПРИЛОЖЕНИЯ:

    1. Копия документа, удостоверяющего личность
    2. Копия правоустанавливающего документа на жилое помещение
    3. Копия распоряжения о согласовании перепланировки
    4. Акт приемочной комиссии о завершенной перепланировке
    5. Квитанция об оплате услуг БТИ


Дата: {self.current_date}                          Подпись: _______________ ({owner_name})
        """

        return document

    def _format_renovation_description(self, plan: FloorPlan) -> str:
        """Форматирование описания работ по перепланировке"""
        lines = []

        # Подсчет элементов
        load_bearing_walls = sum(1 for w in plan.walls if w.isLoadBearing)
        non_load_bearing_walls = sum(1 for w in plan.walls if not w.isLoadBearing)

        lines.append(f"    • Количество несущих стен: {load_bearing_walls}")
        lines.append(f"    • Количество ненесущих перегородок: {non_load_bearing_walls}")
        lines.append(f"    • Количество дверных проемов: {len(plan.doors)}")
        lines.append(f"    • Количество оконных проемов: {len(plan.windows)}")
        lines.append(f"    • Количество помещений после перепланировки: {len(plan.rooms)}")

        if plan.hasGasSupply:
            lines.append("    • Наличие газоснабжения: Да (требуется согласование с газовой службой)")

        return "\n".join(lines)

    def _format_technical_analysis(self, analysis: AnalysisResult) -> str:
        """Форматирование технического анализа"""
        lines = []

        if analysis.warnings:
            lines.append("ВЫЯВЛЕННЫЕ ЗАМЕЧАНИЯ И ТРЕБОВАНИЯ:\n")

            critical_warnings = [w for w in analysis.warnings if w.level == "critical"]
            high_warnings = [w for w in analysis.warnings if w.level == "high"]
            medium_warnings = [w for w in analysis.warnings if w.level == "medium"]

            if critical_warnings:
                lines.append("КРИТИЧЕСКИЕ ЗАМЕЧАНИЯ (требуется исключение из проекта):")
                for i, w in enumerate(critical_warnings, 1):
                    lines.append(f"    {i}. {w.message}")
                    lines.append(f"       Законодательная база: {', '.join(w.references)}")
                lines.append("")

            if high_warnings:
                lines.append("ТРЕБУЕТСЯ ОБЯЗАТЕЛЬНОЕ СОГЛАСОВАНИЕ:")
                for i, w in enumerate(high_warnings, 1):
                    lines.append(f"    {i}. {w.message}")
                    if w.recommendation:
                        lines.append(f"       Рекомендация: {w.recommendation}")
                lines.append("")

            if medium_warnings:
                lines.append("РЕКОМЕНДАЦИИ К ИСПОЛНЕНИЮ:")
                for i, w in enumerate(medium_warnings, 1):
                    lines.append(f"    {i}. {w.message}")
        else:
            lines.append("Замечаний не выявлено. Проект соответствует нормативным требованиям.")

        return "\n".join(lines)

    def _generate_conclusion(self, analysis: AnalysisResult) -> str:
        """Генерация заключения на основе анализа"""
        critical_warnings = [w for w in analysis.warnings if w.level == "critical"]

        if critical_warnings:
            return """
    На основании проведенного обследования и анализа представленного проекта,
    ЗАКЛЮЧАЮ: перепланировка в представленном виде НЕ МОЖЕТ БЫТЬ СОГЛАСОВАНА
    в связи с нарушением требований действующих строительных норм и правил.

    Необходима доработка проекта с исключением работ, затрагивающих несущие
    конструкции и нарушающих санитарно-технические нормы.
            """
        else:
            return f"""
    На основании проведенного обследования и анализа представленного проекта,
    ЗАКЛЮЧАЮ: перепланировка жилого помещения в соответствии с представленным
    проектом ВОЗМОЖНА при соблюдении следующих условий:

    1. Выполнение работ строго в соответствии с утвержденным проектом
    2. Использование сертифицированных материалов
    3. Привлечение квалифицированных специалистов
    4. Соблюдение технологии производства работ
    5. Обеспечение приемки работ комиссией

    Ориентировочный срок согласования: {analysis.estimatedApprovalTime}
    Ориентировочная стоимость согласования: {analysis.estimatedCost}
            """

    def _generate_recommendations(self, analysis: AnalysisResult) -> str:
        """Генерация рекомендаций"""
        recommendations = []

        recommendations.append("1. Перед началом работ получить письменное разрешение жилищной инспекции")
        recommendations.append("2. Обеспечить доступ представителей контролирующих органов на объект")
        recommendations.append("3. Вести журнал производства работ")
        recommendations.append("4. Сохранять документы о качестве используемых материалов")
        recommendations.append("5. По завершении работ пригласить приемочную комиссию")
        recommendations.append("6. Внести изменения в технический паспорт БТИ в течение 30 дней")
        recommendations.append("7. Зарегистрировать изменения в Росреестре")

        return "\n".join(recommendations)

    def _get_building_type_name(self, building_type: str) -> str:
        """Получение полного названия типа здания"""
        types = {
            "panel": "Панельный дом",
            "brick": "Кирпичный дом",
            "monolithic": "Монолитный дом",
            "block": "Блочный дом"
        }
        return types.get(building_type, "Тип не определен")

    def generate_document_checklist(self) -> str:
        """
        Генерация чек-листа необходимых документов для согласования перепланировки
        """

        return """
                ЧЕК-ЛИСТ ДОКУМЕНТОВ ДЛЯ СОГЛАСОВАНИЯ ПЕРЕПЛАНИРОВКИ

═══════════════════════════════════════════════════════════════════════════

ЭТАП 1: ПОДГОТОВКА К СОГЛАСОВАНИЮ

□ Технический паспорт БТИ (с поэтажным планом и экспликацией)
□ Выписка из ЕГРН (свежая, не старше 1 месяца)
□ Копия документа, удостоверяющего личность
□ Проект перепланировки (от организации с допуском СРО)
□ Техническое заключение о возможности перепланировки
□ Согласие всех собственников (нотариально заверенное)
□ Согласие членов семьи (для муниципального жилья)
□ Согласие органов опеки (если собственник - несовершеннолетний)

ЭТАП 2: ПОДАЧА ДОКУМЕНТОВ

□ Заявление на согласование перепланировки (по установленной форме)
□ Полный пакет документов из Этапа 1
□ Копии всех документов (по 2 экземпляра)
□ Квитанция об оплате госпошлины (если требуется)

ЭТАП 3: ВЫПОЛНЕНИЕ РАБОТ

□ Распоряжение о согласовании перепланировки (получено)
□ Договор с подрядной организацией
□ Допуски и сертификаты специалистов
□ Журнал производства работ
□ Документы о качестве материалов

ЭТАП 4: ПРИЕМКА РАБОТ

□ Уведомление жилищной инспекции о завершении работ
□ Акт освидетельствования скрытых работ (если применимо)
□ Акт приемочной комиссии о завершенной перепланировке
□ Фотофиксация выполненных работ

ЭТАП 5: ОФОРМЛЕНИЕ ИЗМЕНЕНИЙ

□ Заявление в БТИ о внесении изменений
□ Новый технический паспорт БТИ
□ Заявление в Росреестр о регистрации изменений
□ Новая выписка из ЕГРН

═══════════════════════════════════════════════════════════════════════════

ВАЖНЫЕ СРОКИ:

• Рассмотрение заявления: 20-45 дней
• Внесение изменений в БТИ: до 30 дней после завершения
• Регистрация в Росреестре: 7-12 рабочих дней

ВАЖНЫЕ КОНТАКТЫ:

• Жилищная инспекция: _______________________________
• БТИ: ______________________________________________
• МФЦ: ______________________________________________
• Госуслуги: www.gosuslugi.ru

═══════════════════════════════════════════════════════════════════════════
        """
